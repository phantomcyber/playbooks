{
    "blockly": false,
    "blockly_xml": "<xml></xml>",
    "category": "Threat Response",
    "coa": {
        "data": {
            "description": "This workflow performs a user deletion on the Flash Array (On-Premises Target) using the names provided as an input variable via Artifacts.\nThis operation can be triggered by Splunk SOAR Playbook to safeguard against multiple failed login attempts to the Flash Array",
            "edges": [
                {
                    "id": "port_0_to_port_2",
                    "sourceNode": "0",
                    "sourcePort": "0_out",
                    "targetNode": "2",
                    "targetPort": "2_in"
                },
                {
                    "id": "port_2_to_port_10",
                    "sourceNode": "2",
                    "sourcePort": "2_out",
                    "targetNode": "10",
                    "targetPort": "10_in"
                },
                {
                    "id": "port_10_to_port_6",
                    "sourceNode": "10",
                    "sourcePort": "10_out",
                    "targetNode": "6",
                    "targetPort": "6_in"
                },
                {
                    "id": "port_6_to_port_11",
                    "sourceNode": "6",
                    "sourcePort": "6_out",
                    "targetNode": "11",
                    "targetPort": "11_in"
                },
                {
                    "id": "port_11_to_port_12",
                    "sourceNode": "11",
                    "sourcePort": "11_out",
                    "targetNode": "12",
                    "targetPort": "12_in"
                },
                {
                    "id": "port_12_to_port_13",
                    "sourceNode": "12",
                    "sourcePort": "12_out",
                    "targetNode": "13",
                    "targetPort": "13_in"
                },
                {
                    "id": "port_13_to_port_15",
                    "sourceNode": "13",
                    "sourcePort": "13_out",
                    "targetNode": "15",
                    "targetPort": "15_in"
                },
                {
                    "id": "port_15_to_port_16",
                    "sourceNode": "15",
                    "sourcePort": "15_out",
                    "targetNode": "16",
                    "targetPort": "16_in"
                },
                {
                    "id": "port_16_to_port_1",
                    "sourceNode": "16",
                    "sourcePort": "16_out",
                    "targetNode": "1",
                    "targetPort": "1_in"
                }
            ],
            "hash": "153e93c9be17332afe6dee1a7998edb46e76271b",
            "nodes": {
                "0": {
                    "data": {
                        "advanced": {
                            "join": []
                        },
                        "functionName": "on_start",
                        "id": "0",
                        "type": "start"
                    },
                    "errors": {},
                    "id": "0",
                    "type": "start",
                    "warnings": {},
                    "x": 1000,
                    "y": 459.9999999999993
                },
                "1": {
                    "data": {
                        "advanced": {
                            "join": []
                        },
                        "functionName": "on_finish",
                        "id": "1",
                        "type": "end"
                    },
                    "errors": {},
                    "id": "1",
                    "type": "end",
                    "warnings": {},
                    "x": 1000,
                    "y": 1700
                },
                "10": {
                    "customCode": "@phantom.playbook_block()\ndef fetch_latest_fa_api_version(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"fetch_latest_fa_api_version() called\")\n\n    list_the_flash_array_versions_result_data = phantom.collect2(container=container, datapath=[\"list_the_flash_array_versions:action_result.data.*.parsed_response_body\"], action_results=results)\n\n    ################################################################################\n    ## Custom Code Start\n    ################################################################################\n\n    # Write your custom code here...\n    list_the_flash_array_versions_result_item_0 = [item[0] for item in list_the_flash_array_versions_result_data]\n\n    fetch_latest_fa_api_version__latestvers = list_the_flash_array_versions_result_item_0[0]['version'][-1]\n\n    ################################################################################\n    ## Custom Code End\n    ################################################################################\n\n    phantom.save_run_data(key=\"fetch_latest_fa_api_version:latestvers\", value=json.dumps(fetch_latest_fa_api_version__latestvers))\n\n    flasharray_login(container=container)\n\n    return",
                    "data": {
                        "advanced": {
                            "customName": "Fetch latest FA API version",
                            "customNameId": 0,
                            "join": []
                        },
                        "functionId": 1,
                        "functionName": "fetch_latest_fa_api_version",
                        "id": "10",
                        "inputParameters": [
                            "list_the_flash_array_versions:action_result.data.*.parsed_response_body"
                        ],
                        "outputVariables": [
                            "latestvers"
                        ],
                        "type": "code"
                    },
                    "errors": {},
                    "id": "10",
                    "type": "code",
                    "userCode": null,
                    "warnings": {},
                    "x": 980,
                    "y": 720
                },
                "11": {
                    "customCode": "@phantom.playbook_block()\ndef fetch_the_auth_token(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"fetch_the_auth_token() called\")   \n    \n    flasharray_login_result_data = phantom.collect2(container=container, datapath=[\"flasharray_login:action_result.data.*.response_headers.x-auth-token\"], action_results=results)\n\n    ################################################################################\n    ## Custom Code Start\n    ################################################################################\n\n    # Write your custom code here...\n    flasharray_login_result_item_0 = [item[0] for item in flasharray_login_result_data]\n    phantom.debug(flasharray_login_result_data[0][0])\n\n    fetch_the_auth_token__x_auth_token = flasharray_login_result_data[0][0]\n\n    ################################################################################\n    ## Custom Code End\n    ################################################################################\n\n    phantom.save_run_data(key=\"fetch_the_auth_token:x_auth_token\", value=json.dumps(fetch_the_auth_token__x_auth_token))\n    \n    get_flash_array_users_list(container=container)\n\n\n    return",
                    "data": {
                        "advanced": {
                            "customName": "Fetch the Auth Token",
                            "customNameId": 0,
                            "join": []
                        },
                        "functionId": 2,
                        "functionName": "fetch_the_auth_token",
                        "id": "11",
                        "inputParameters": [
                            "flasharray_login:action_result.data.*.response_headers"
                        ],
                        "outputVariables": [
                            "X Auth Token"
                        ],
                        "type": "code"
                    },
                    "errors": {},
                    "id": "11",
                    "type": "code",
                    "userCode": null,
                    "warnings": {},
                    "x": 980,
                    "y": 980
                },
                "12": {
                    "customCode": "@phantom.playbook_block()\ndef get_flash_array_users_list(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"get_flash_array_users_list() called\")\n\n    # phantom.debug('Action: {0} {1}'.format(action['name'], ('SUCCEEDED' if success else 'FAILED')))\n\n    location_formatted_string = phantom.format(\n        container=container,\n        template=\"\"\"/api/{0}/admins\\n\"\"\",\n        parameters=[\n            \"fetch_latest_fa_api_version:custom_function:latestvers\"\n        ])\n\n   # Get the x_auth_token from the previous code step\n    x_auth_token = phantom.get_run_data(key=\"fetch_the_auth_token:x_auth_token\")\n    \n    # Ensure the token is in the correct format\n    x_auth_token = x_auth_token.strip('\"')\n    \n    # Create the headers dictionary\n    headers = {\n        \"x-auth-token\": x_auth_token\n    }\n    \n    # Debug statements to verify values\n    phantom.debug(f\"Formatted location string: {location_formatted_string}\")\n    phantom.debug(f\"Auth token: {x_auth_token}\")\n    phantom.debug(f\"Headers: {json.dumps(headers)}\")\n\n    parameters = []\n\n    if location_formatted_string is not None:\n        parameters.append({\n            \"headers\": json.dumps(headers),  # Ensure headers are passed as a JSON string\n            \"location\": location_formatted_string,\n        })\n\n    ################################################################################\n    ## Custom Code Start\n    ################################################################################\n\n    # Write your custom code here...\n\n    ################################################################################\n    ## Custom Code End\n    ################################################################################\n\n    phantom.act(\"get data\", parameters=parameters, name=\"get_flash_array_users_list\", assets=[\"purearray\"], callback=extract_all_the_current_users)\n\n\n    return",
                    "data": {
                        "action": "get data",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "Get Flash Array users List",
                            "customNameId": 0,
                            "join": []
                        },
                        "connector": "HTTP",
                        "connectorConfigs": [
                            "purearray"
                        ],
                        "connectorId": "290b7499-0374-4930-9cdc-5e9b05d65827",
                        "connectorVersion": "v1",
                        "functionId": 2,
                        "functionName": "get_flash_array_users_list",
                        "id": "12",
                        "loop": {
                            "enabled": false,
                            "exitAfterUnit": "m",
                            "exitAfterValue": 10,
                            "exitConditionEnabled": false,
                            "exitLoopAfter": 2,
                            "pauseUnit": "m",
                            "pauseValue": 2
                        },
                        "parameters": {
                            "headers": "fetch_the_auth_token:custom_function:x_auth_token",
                            "location": {
                                "functionId": 2,
                                "parameters": [
                                    "fetch_latest_fa_api_version:custom_function:latestvers"
                                ],
                                "template": "/api/{0}/admins\n"
                            }
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "location"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "12",
                    "type": "action",
                    "userCode": null,
                    "warnings": {},
                    "x": 980,
                    "y": 1100
                },
                "13": {
                    "customCode": "@phantom.playbook_block()\ndef extract_all_the_current_users(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"extract_all_the_current_users() called\")\n    \n     # Collect the parsed response body from the fetch_vol action\n    get_flash_array_users_list_result_data = phantom.collect2(container=container, datapath=[\"get_flash_array_users_list:action_result.data.*.parsed_response_body.items.*.name\"], action_results=results)\n\n    user_names = []\n    if get_flash_array_users_list_result_data:\n        try:\n            for item in get_flash_array_users_list_result_data:\n                if item[0]:  # Ensure there is a name present\n                    user_names.append(item[0])\n\n        except Exception as e:\n            phantom.error(f\"Error extracting user names: {str(e)}\")\n\n    # Join the user names with newline characters for better readability\n    formatted_user_names = \"\\n\".join(user_names)\n\n    # Debug statement to display only the formatted user names\n    phantom.debug(f\"Formatted user names:\\n{formatted_user_names}\")\n\n    # Save the extracted user names to run data \n    extract_all_the_current_users__names = user_names\n    phantom.save_run_data(key=\"extract_all_the_current_users:users_names\", value=json.dumps(extract_all_the_current_users__names))\n    \n    delete_the_user(container=container)\n\n    return",
                    "data": {
                        "advanced": {
                            "customName": "Extract all the current users",
                            "customNameId": 0,
                            "join": []
                        },
                        "functionId": 3,
                        "functionName": "extract_all_the_current_users",
                        "id": "13",
                        "inputParameters": [
                            "get_flash_array_users_list:action_result.data.*.parsed_response_body"
                        ],
                        "outputVariables": [
                            "users"
                        ],
                        "type": "code"
                    },
                    "errors": {},
                    "id": "13",
                    "type": "code",
                    "userCode": null,
                    "warnings": {},
                    "x": 980,
                    "y": 1240
                },
                "15": {
                    "customCode": "@phantom.playbook_block()\ndef delete_the_user(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"delete_the_user() called\")\n\n   # Collect the user name from the artifact\n    user_name_artifact = phantom.collect2(container=container, datapath=[\"artifact:*.cef.user_name\"])\n    \n    # Log collected artifacts for debugging\n    phantom.debug(f\"Collected user name artifact: {user_name_artifact}\")\n\n    # Concatenate the user names into a single string\n    if user_name_artifact and user_name_artifact[0][0]:\n        user_name = user_name_artifact[0][0]\n    else:\n        user_name = \"default_user_name\"  # Provide a default user name or handle the error\n\n    phantom.debug(f\"Using user name: {user_name}\")\n\n    # Retrieve the latest API version\n    latestvers = phantom.get_run_data(key=\"fetch_latest_fa_api_version:latestvers\").strip('\"')\n    \n    # Debug the latest version value\n    phantom.debug(f\"Latest API version: {latestvers}\")\n\n    # Create the location string for the API call\n    location_formatted_string = f\"/api/{latestvers}/admins\"\n\n    # Retrieve the auth token\n    x_auth_token = phantom.get_run_data(key=\"fetch_the_auth_token:x_auth_token\").strip('\"')\n\n    # Debug the x-auth-token value\n    phantom.debug(f\"x-auth-token: {x_auth_token}\")\n\n    # Create the headers dictionary\n    headers = {\n        \"x-auth-token\": x_auth_token,\n        \"Content-Type\": \"application/json\"\n    }\n\n    # Create the body for the delete request\n    body = {\n        \"names\": user_name\n    }\n\n    parameters = []\n\n    if location_formatted_string is not None:\n        parameters.append({\n            \"headers\": json.dumps(headers),  # Ensure headers are passed as a JSON string\n            \"location\": location_formatted_string,\n            \"body\": json.dumps(body)  # Add the body to the request\n        })\n\n    # Debug parameters to ensure they are correct\n    phantom.debug(f\"Parameters: {parameters}\")\n\n    # Perform the delete action\n    phantom.act(\"delete data\", parameters=parameters, name=\"delete_the_user\", assets=[\"purearray\"],callback=logout_of_the_flash_array)\n\n    return",
                    "data": {
                        "action": "delete data",
                        "actionType": "generic",
                        "advanced": {
                            "customName": "Delete the User",
                            "customNameId": 0,
                            "join": []
                        },
                        "connector": "HTTP",
                        "connectorConfigs": [
                            "purearray"
                        ],
                        "connectorId": "290b7499-0374-4930-9cdc-5e9b05d65827",
                        "connectorVersion": "v1",
                        "functionId": 1,
                        "functionName": "delete_the_user",
                        "id": "15",
                        "loop": {
                            "enabled": false,
                            "exitAfterUnit": "m",
                            "exitAfterValue": 10,
                            "exitConditionEnabled": false,
                            "exitLoopAfter": 2,
                            "pauseUnit": "m",
                            "pauseValue": 2
                        },
                        "parameters": {
                            "headers": "fetch_the_auth_token:custom_function:x_auth_token",
                            "location": {
                                "functionId": 1,
                                "parameters": [
                                    "fetch_latest_fa_api_version:custom_function:latestvers"
                                ],
                                "template": "/api/{0}/admins\n"
                            }
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "location"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "15",
                    "type": "action",
                    "warnings": {},
                    "x": 980,
                    "y": 1420
                },
                "16": {
                    "customCode": "@phantom.playbook_block()\ndef logout_of_the_flash_array(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"logout_of_the_flash_array() called\")\n\n     # Retrieve the latest version and x_auth_token from the run data\n    fetch_latest_fa_api_version__latestvers = phantom.get_run_data(key=\"fetch_latest_fa_api_version:latestvers\").strip('\"')\n    fetch_the_auth_token__x_auth_token = phantom.get_run_data(key=\"fetch_the_auth_token:x_auth_token\").strip('\"')\n\n    # Log the retrieved values for debugging\n    phantom.debug(f\"Latest version: {fetch_latest_fa_api_version__latestvers}\")\n    phantom.debug(f\"X-Auth-Token: {fetch_the_auth_token__x_auth_token}\")\n\n    # Check if the version and x_auth_token were retrieved successfully\n    if not fetch_latest_fa_api_version__latestvers:\n        phantom.error(\"Latest version not found\")\n        return\n    if not fetch_the_auth_token__x_auth_token:\n        phantom.error(\"X-Auth-Token not found\")\n        return\n\n    # Format the location string using the latest version\n    location_formatted_string = f\"/api/{fetch_latest_fa_api_version__latestvers}/logout\"\n\n    # Prepare headers as a dictionary\n    headers = {\n        \"X-Auth-Token\": fetch_the_auth_token__x_auth_token,\n        \"Content-Type\": \"application/json\"\n    }\n\n    # Prepare the parameters for the post data action\n    parameters = [{\n        \"location\": location_formatted_string,\n        \"headers\": json.dumps(headers)  # Convert headers to JSON string\n    }]\n\n    # Debug the prepared parameters\n    phantom.debug(f\"parameters: {parameters}\")\n\n    ################################################################################\n    ## Custom Code Start\n    ################################################################################\n\n    # Write your custom code here...\n\n    ################################################################################\n    ## Custom Code End\n    ################################################################################\n\n    # Perform the post data action with the prepared parameters\n    if parameters:\n        phantom.act(\"post data\", parameters=parameters, name=\"logout_of_the_flash_array\", assets=[\"purearray\"])\n    else:\n        phantom.error(\"No valid parameters found for post data action.\")\n\n    return",
                    "data": {
                        "action": "post data",
                        "actionType": "generic",
                        "advanced": {
                            "customName": "Logout of the Flash Array",
                            "customNameId": 0,
                            "join": []
                        },
                        "connector": "HTTP",
                        "connectorConfigs": [
                            "purearray"
                        ],
                        "connectorId": "290b7499-0374-4930-9cdc-5e9b05d65827",
                        "connectorVersion": "v1",
                        "functionId": 2,
                        "functionName": "logout_of_the_flash_array",
                        "id": "16",
                        "loop": {
                            "enabled": false,
                            "exitAfterUnit": "m",
                            "exitAfterValue": 10,
                            "exitConditionEnabled": false,
                            "exitLoopAfter": 2,
                            "pauseUnit": "m",
                            "pauseValue": 2
                        },
                        "parameters": {
                            "headers": "fetch_the_auth_token:custom_function:x_auth_token",
                            "location": {
                                "functionId": 2,
                                "parameters": [
                                    "fetch_latest_fa_api_version:custom_function:latestvers"
                                ],
                                "template": "/api/{0}/logout\n"
                            }
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "location"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "16",
                    "type": "action",
                    "userCode": null,
                    "warnings": {},
                    "x": 980,
                    "y": 1560
                },
                "2": {
                    "data": {
                        "action": "get data",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "List  the Flash Array Versions",
                            "customNameId": 0,
                            "join": []
                        },
                        "connector": "HTTP",
                        "connectorConfigs": [
                            "purearray"
                        ],
                        "connectorId": "290b7499-0374-4930-9cdc-5e9b05d65827",
                        "connectorVersion": "v1",
                        "functionId": 1,
                        "functionName": "list_the_flash_array_versions",
                        "id": "2",
                        "loop": {
                            "conditions": [
                                {
                                    "comparisons": [
                                        {
                                            "conditionIndex": 0,
                                            "op": "==",
                                            "param": "",
                                            "value": ""
                                        }
                                    ],
                                    "conditionIndex": 0,
                                    "display": "If",
                                    "logic": "and",
                                    "type": "if"
                                }
                            ],
                            "enabled": false,
                            "exitAfterUnit": "m",
                            "exitAfterValue": 10,
                            "exitConditionEnabled": false,
                            "exitLoopAfter": 2,
                            "pauseUnit": "m",
                            "pauseValue": 2
                        },
                        "parameters": {
                            "location": "/api/api_version"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "location"
                            }
                        ],
                        "tab": "byAction",
                        "type": "action"
                    },
                    "errors": {},
                    "id": "2",
                    "type": "action",
                    "warnings": {},
                    "x": 980,
                    "y": 600
                },
                "6": {
                    "customCode": "@phantom.playbook_block()\ndef flasharray_login(action=None, success=None, container=None, results=None, handle=None, filtered_artifacts=None, filtered_results=None, custom_function=None, loop_state_json=None, **kwargs):\n    phantom.debug(\"flasharray_login() called\")\n\n    # phantom.debug('Action: {0} {1}'.format(action['name'], ('SUCCEEDED' if success else 'FAILED')))\n\n    location_formatted_string = phantom.format(\n        container=container,\n        template=\"\"\"\\n/api/{0}/login\\n\"\"\",\n        parameters=[\n            \"fetch_latest_fa_api_version:custom_function:latestvers\"\n        ])\n\n    fetch_latest_fa_api_version__latestvers = json.loads(_ if (_ := phantom.get_run_data(key=\"fetch_latest_fa_api_version:latestvers\")) != \"\" else \"null\")  # pylint: disable=used-before-assignment\n\n    parameters = []\n\n    if location_formatted_string is not None:\n        parameters.append({\n            \"location\": location_formatted_string,\n        })\n\n    ################################################################################\n    ## Custom Code Start\n    ################################################################################\n\n    # Write your custom code here...\n\n    ################################################################################\n    ## Custom Code End\n    ################################################################################\n\n    phantom.act(\"post data\", parameters=parameters, name=\"flasharray_login\", assets=[\"purearray\"], callback=fetch_the_auth_token)\n\n    return",
                    "data": {
                        "action": "post data",
                        "actionType": "generic",
                        "advanced": {
                            "customName": "FlashArray Login",
                            "customNameId": 0,
                            "join": []
                        },
                        "connector": "HTTP",
                        "connectorConfigs": [
                            "purearray"
                        ],
                        "connectorId": "290b7499-0374-4930-9cdc-5e9b05d65827",
                        "connectorVersion": "v1",
                        "customDatapaths": {
                            "fetch_vers": {
                                "action_result.data.*.parsed_response_body.version": {
                                    "contains": [],
                                    "isCustomDatapath": true,
                                    "label": "action_result.data.*.parsed_response_body.version",
                                    "value": "fetch_vers:action_result.data.*.parsed_response_body.version"
                                }
                            }
                        },
                        "functionId": 1,
                        "functionName": "flasharray_login",
                        "id": "6",
                        "loop": {
                            "enabled": false,
                            "exitAfterUnit": "m",
                            "exitAfterValue": 10,
                            "exitConditionEnabled": false,
                            "exitLoopAfter": 2,
                            "pauseUnit": "m",
                            "pauseValue": 2
                        },
                        "parameters": {
                            "location": {
                                "functionId": 1,
                                "parameters": [
                                    "fetch_latest_fa_api_version:custom_function:latestvers"
                                ],
                                "template": "\n/api/{0}/login\n"
                            }
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "location"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "6",
                    "type": "action",
                    "warnings": {},
                    "x": 980,
                    "y": 860
                }
            },
            "notes": "",
            "origin": {
                "playbook_id": 1140,
                "playbook_name": "DON\"T EDIT-Pure-Storage-User-Deletion",
                "playbook_repo_id": 2,
                "playbook_repo_name": "local"
            }
        },
        "input_spec": null,
        "output_spec": null,
        "playbook_trigger": "artifact_created",
        "playbook_type": "automation",
        "python_version": "3",
        "schema": "5.0.12",
        "version": "6.2.2.134"
    },
    "create_time": "2024-08-06T17:18:19.288836+00:00",
    "draft_mode": false,
    "labels": [
        "events"
    ],
    "tags": []
}