{
    "blockly": false,
    "blockly_xml": "<xml></xml>",
    "category": "Uncategorized",
    "coa": {
        "data": {
            "description": "Starting with a single IP address, this playbook gathers a list of linked IP addresses, domain names, file hashes, urls, and vulnerability CVE's from Recorded Future. Then Splunk is used to build threat hunting lookup tables and search across multiple data sources for events containing the linked entities. Finally, IP addresses are blocked if approved by an analyst and an email is sent to notify a responder of the activity.",
            "edges": [
                {
                    "id": "port_0_to_port_2",
                    "sourceNode": "0",
                    "sourcePort": "0_out",
                    "targetNode": "2",
                    "targetPort": "2_in"
                },
                {
                    "id": "port_2_to_port_3",
                    "sourceNode": "2",
                    "sourcePort": "2_out",
                    "targetNode": "3",
                    "targetPort": "3_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_3_to_port_4",
                    "sourceNode": "3",
                    "sourcePort": "3_out",
                    "targetNode": "4",
                    "targetPort": "4_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_3_to_port_5",
                    "sourceNode": "3",
                    "sourcePort": "3_out",
                    "targetNode": "5",
                    "targetPort": "5_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_3_to_port_6",
                    "sourceNode": "3",
                    "sourcePort": "3_out",
                    "targetNode": "6",
                    "targetPort": "6_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_3_to_port_7",
                    "sourceNode": "3",
                    "sourcePort": "3_out",
                    "targetNode": "7",
                    "targetPort": "7_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_3_to_port_8",
                    "sourceNode": "3",
                    "sourcePort": "3_out",
                    "targetNode": "8",
                    "targetPort": "8_in"
                },
                {
                    "id": "port_4_to_port_9",
                    "sourceNode": "4",
                    "sourcePort": "4_out",
                    "targetNode": "9",
                    "targetPort": "9_in"
                },
                {
                    "id": "port_5_to_port_10",
                    "sourceNode": "5",
                    "sourcePort": "5_out",
                    "targetNode": "10",
                    "targetPort": "10_in"
                },
                {
                    "id": "port_6_to_port_11",
                    "sourceNode": "6",
                    "sourcePort": "6_out",
                    "targetNode": "11",
                    "targetPort": "11_in"
                },
                {
                    "id": "port_7_to_port_12",
                    "sourceNode": "7",
                    "sourcePort": "7_out",
                    "targetNode": "12",
                    "targetPort": "12_in"
                },
                {
                    "id": "port_8_to_port_13",
                    "sourceNode": "8",
                    "sourcePort": "8_out",
                    "targetNode": "13",
                    "targetPort": "13_in"
                },
                {
                    "id": "port_9_to_port_14",
                    "sourceNode": "9",
                    "sourcePort": "9_out",
                    "targetNode": "14",
                    "targetPort": "14_in"
                },
                {
                    "id": "port_10_to_port_15",
                    "sourceNode": "10",
                    "sourcePort": "10_out",
                    "targetNode": "15",
                    "targetPort": "15_in"
                },
                {
                    "id": "port_11_to_port_16",
                    "sourceNode": "11",
                    "sourcePort": "11_out",
                    "targetNode": "16",
                    "targetPort": "16_in"
                },
                {
                    "id": "port_12_to_port_17",
                    "sourceNode": "12",
                    "sourcePort": "12_out",
                    "targetNode": "17",
                    "targetPort": "17_in"
                },
                {
                    "id": "port_13_to_port_18",
                    "sourceNode": "13",
                    "sourcePort": "13_out",
                    "targetNode": "18",
                    "targetPort": "18_in"
                },
                {
                    "id": "port_14_to_port_19",
                    "sourceNode": "14",
                    "sourcePort": "14_out",
                    "targetNode": "19",
                    "targetPort": "19_in"
                },
                {
                    "id": "port_19_to_port_20",
                    "sourceNode": "19",
                    "sourcePort": "19_out",
                    "targetNode": "20",
                    "targetPort": "20_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_20_to_port_21",
                    "sourceNode": "20",
                    "sourcePort": "20_out",
                    "targetNode": "21",
                    "targetPort": "21_in"
                },
                {
                    "id": "port_15_to_port_22",
                    "sourceNode": "15",
                    "sourcePort": "15_out",
                    "targetNode": "22",
                    "targetPort": "22_in"
                },
                {
                    "id": "port_16_to_port_22",
                    "sourceNode": "16",
                    "sourcePort": "16_out",
                    "targetNode": "22",
                    "targetPort": "22_in"
                },
                {
                    "id": "port_17_to_port_22",
                    "sourceNode": "17",
                    "sourcePort": "17_out",
                    "targetNode": "22",
                    "targetPort": "22_in"
                },
                {
                    "id": "port_18_to_port_22",
                    "sourceNode": "18",
                    "sourcePort": "18_out",
                    "targetNode": "22",
                    "targetPort": "22_in"
                },
                {
                    "id": "port_14_to_port_22",
                    "sourceNode": "14",
                    "sourcePort": "14_out",
                    "targetNode": "22",
                    "targetPort": "22_in"
                },
                {
                    "id": "port_22_to_port_23",
                    "sourceNode": "22",
                    "sourcePort": "22_out",
                    "targetNode": "23",
                    "targetPort": "23_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_23_to_port_25",
                    "sourceNode": "23",
                    "sourcePort": "23_out",
                    "targetNode": "25",
                    "targetPort": "25_in"
                },
                {
                    "conditions": [
                        {
                            "index": 0
                        }
                    ],
                    "id": "port_23_to_port_26",
                    "sourceNode": "23",
                    "sourcePort": "23_out",
                    "targetNode": "26",
                    "targetPort": "26_in"
                },
                {
                    "id": "port_26_to_port_1",
                    "sourceNode": "26",
                    "sourcePort": "26_out",
                    "targetNode": "1",
                    "targetPort": "1_in"
                },
                {
                    "id": "port_25_to_port_1",
                    "sourceNode": "25",
                    "sourcePort": "25_out",
                    "targetNode": "1",
                    "targetPort": "1_in"
                },
                {
                    "id": "port_21_to_port_1",
                    "sourceNode": "21",
                    "sourcePort": "21_out",
                    "targetNode": "1",
                    "targetPort": "1_in"
                }
            ],
            "hash": "93ea468ac323c3efc201469bf59233c67b9179a2",
            "nodes": {
                "0": {
                    "data": {
                        "advanced": {
                            "join": []
                        },
                        "functionName": "on_start",
                        "id": "0",
                        "type": "start"
                    },
                    "errors": {},
                    "id": "0",
                    "type": "start",
                    "x": 1080,
                    "y": 359.9999999999999
                },
                "1": {
                    "data": {
                        "advanced": {
                            "join": []
                        },
                        "functionId": 1,
                        "functionName": "on_finish",
                        "id": "1",
                        "type": "end"
                    },
                    "errors": {},
                    "id": "1",
                    "type": "end",
                    "userCode": "\n    # This function is called after all actions are completed.\n    # summary of all the action and/or all details of actions\n    # can be collected here.\n\n    # summary_json = phantom.get_summary()\n    # if 'result' in summary_json:\n        # for action_result in summary_json['result']:\n            # if 'action_run_id' in action_result:\n                # action_results = phantom.get_action_results(action_run_id=action_result['action_run_id'], result_data=False, flatten=False)\n                # phantom.debug(action_results)\n\n",
                    "x": 1000,
                    "y": 1840
                },
                "10": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "build domain lookup",
                            "customNameId": 0,
                            "description": "Run the Splunk query that creates the lookup file",
                            "join": [],
                            "note": "Run the Splunk query that creates the lookup file"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 2,
                        "functionName": "build_domain_lookup",
                        "id": "10",
                        "parameters": {
                            "command": "| makeresults",
                            "query": "format_linked_domain_lookup:formatted_data"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "10",
                    "type": "action",
                    "x": 740,
                    "y": 984.5
                },
                "11": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "build file lookup",
                            "customNameId": 0,
                            "description": "Run the Splunk query that creates the lookup file",
                            "join": [],
                            "note": "Run the Splunk query that creates the lookup file"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 3,
                        "functionName": "build_file_lookup",
                        "id": "11",
                        "parameters": {
                            "command": "| makeresults",
                            "query": "format_linked_files_lookup:formatted_data"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "11",
                    "type": "action",
                    "x": 1060,
                    "y": 1020
                },
                "12": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "build vuln lookup",
                            "customNameId": 0,
                            "description": "Run the Splunk query that creates the lookup file",
                            "join": [],
                            "note": "Run the Splunk query that creates the lookup file"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 4,
                        "functionName": "build_vuln_lookup",
                        "id": "12",
                        "parameters": {
                            "command": "| makeresults",
                            "query": "format_linked_vuln_lookup:formatted_data"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "12",
                    "type": "action",
                    "x": 1380,
                    "y": 984.5
                },
                "13": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "build url lookup",
                            "customNameId": 0,
                            "description": "Run the Splunk query that creates the lookup file",
                            "join": [],
                            "note": "Run the Splunk query that creates the lookup file"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 5,
                        "functionName": "build_url_lookup",
                        "id": "13",
                        "parameters": {
                            "command": "| makeresults",
                            "query": "format_linked_url_lookup:formatted_data"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "13",
                    "type": "action",
                    "x": 1680,
                    "y": 980
                },
                "14": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "search splunk for ips",
                            "customNameId": 0,
                            "description": "Search Palo Alto Networks firewall logs for any events with threat-related ip addresses in the dest_ip field",
                            "join": [],
                            "note": "Search Palo Alto Networks firewall logs for any events with threat-related ip addresses in the dest_ip field"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 6,
                        "functionName": "search_splunk_for_ips",
                        "id": "14",
                        "parameters": {
                            "command": "search",
                            "query": "sourcetype=\"netscreen:firewall\" ((earliest=-24h latest=now)) |eval Name=dest_ip | lookup huntip.csv Name OUTPUT RF_Risk_Score | search RF_Risk_Score>24"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "14",
                    "type": "action",
                    "x": 440,
                    "y": 1180
                },
                "15": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "search splunk for domains",
                            "customNameId": 0,
                            "description": "Search Palo Alto Networks threat logs for any events with threat-related domain names in the dest_hostname field",
                            "join": [],
                            "note": "Search Palo Alto Networks threat logs for any events with threat-related domain names in the dest_hostname field"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 7,
                        "functionName": "search_splunk_for_domains",
                        "id": "15",
                        "parameters": {
                            "command": "search",
                            "query": "sourcetype=\"netscreen:firewall\" ((earliest=-24h latest=now)) |eval Name=dest_ip | lookup huntip.csv Name OUTPUT RF_Risk_Score | search RF_Risk_Score>24"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "15",
                    "type": "action",
                    "x": 740,
                    "y": 1180
                },
                "16": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "search splunk for files",
                            "customNameId": 0,
                            "description": "Search Symantec Endpoint Protection logs for sightings of threat-related file hashes",
                            "join": [],
                            "note": "Search Symantec Endpoint Protection logs for sightings of threat-related file hashes"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 8,
                        "functionName": "search_splunk_for_files",
                        "id": "16",
                        "parameters": {
                            "command": "search",
                            "query": "index=main sourcetype=symantec:ep:risk:file ((earliest=-1d latest=now)) |eval Name=file_hash | lookup huntfile.csv Name OUTPUT RF_Risk_Score | search RF_Risk_Score>24"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "16",
                    "type": "action",
                    "x": 1060,
                    "y": 1180
                },
                "17": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "search splunk for vulns",
                            "customNameId": 0,
                            "description": "Search Tenable vulnerability scanning logs for any vulnerabilities related to the initial IP addresses",
                            "join": [],
                            "note": "Search Tenable vulnerability scanning logs for any vulnerabilities related to the initial IP addresses"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 9,
                        "functionName": "search_splunk_for_vulns",
                        "id": "17",
                        "parameters": {
                            "command": "search",
                            "query": "index=main sourcetype=\"tenable:sc:vuln\" ((earliest=-7d latest=now)) |eval Name=cve | lookup huntvuln.csv Name OUTPUT RF_Risk_Score | search RF_Risk_Score>24"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "17",
                    "type": "action",
                    "x": 1380,
                    "y": 1164.5
                },
                "18": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "search splunk for urls",
                            "customNameId": 0,
                            "description": "Search Squid Proxy logs for any URLs related to the initial IP addresses",
                            "join": [],
                            "note": "Search Squid Proxy logs for any URLs related to the initial IP addresses"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 10,
                        "functionName": "search_splunk_for_urls",
                        "id": "18",
                        "parameters": {
                            "command": "search",
                            "query": "index=main sourcetype=\"squid:access\" ((earliest=-24h latest=now)) |eval Name=url | lookup hunturl.csv Name OUTPUT RF_Risk_Score | search RF_Risk_Score>24"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "18",
                    "type": "action",
                    "x": 1680,
                    "y": 1180
                },
                "19": {
                    "data": {
                        "advanced": {
                            "customName": "recorded_future_threat_hunting_block_ip",
                            "customNameId": 0,
                            "description": "Ask an analyst whether the discovered related IP addresses should be blocked",
                            "join": [],
                            "note": "Ask an analyst whether the discovered related IP addresses should be blocked"
                        },
                        "approver": "admin",
                        "functionId": 1,
                        "functionName": "recorded_future_threat_hunting_block_ip",
                        "id": "19",
                        "message": "Do you want to add the following IP(s) to the block IP block list:\n{0}",
                        "parameters": [
                            "search_splunk_for_ips:action_result.data.*.IP"
                        ],
                        "responseTime": 30,
                        "responses": [
                            {
                                "responseOptions": [
                                    "Yes",
                                    "No"
                                ],
                                "responsePrompt": "Block IPs?",
                                "responseType": "yes/no"
                            }
                        ],
                        "type": "prompt"
                    },
                    "errors": {},
                    "id": "19",
                    "type": "prompt",
                    "x": 520,
                    "y": 1340
                },
                "2": {
                    "data": {
                        "action": "ip intelligence",
                        "actionType": "investigate",
                        "advanced": {
                            "description": "Query for the full context about the IP address and related entities from Recorded Future",
                            "join": [],
                            "note": "Query for the full context about the IP address and related entities from Recorded Future"
                        },
                        "connector": "Recorded Future",
                        "connectorConfigs": [
                            "recorded future "
                        ],
                        "connectorId": "6efe0e1b-76ac-4ffd-8fa0-ac58fd6efd77",
                        "connectorVersion": "v1",
                        "functionId": 1,
                        "functionName": "ip_intelligence_1",
                        "id": "2",
                        "parameters": {
                            "ip": "artifact:*.cef.destinationAddress"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "ip"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "2",
                    "type": "action",
                    "x": 1060,
                    "y": 460
                },
                "20": {
                    "data": {
                        "advanced": {
                            "join": []
                        },
                        "conditions": [
                            {
                                "comparisons": [
                                    {
                                        "conditionIndex": 0,
                                        "op": "==",
                                        "param": "recorded_future_threat_hunting_block_ip:action_result.summary.responses.0",
                                        "value": "Yes"
                                    }
                                ],
                                "conditionIndex": 0,
                                "display": "If",
                                "logic": "and",
                                "type": "if"
                            }
                        ],
                        "functionId": 2,
                        "functionName": "decision_2",
                        "id": "20",
                        "type": "decision"
                    },
                    "errors": {},
                    "id": "20",
                    "type": "decision",
                    "x": 520,
                    "y": 1484.5
                },
                "21": {
                    "data": {
                        "advanced": {
                            "customName": "add ip to block list",
                            "customNameId": 0,
                            "description": "Add the IP address to a Phantom custom list, which can be tracked as a REST-accessible external block list by a firewall",
                            "join": [],
                            "note": "Add the IP address to a Phantom custom list, which can be tracked as a REST-accessible external block list by a firewall"
                        },
                        "functionId": 1,
                        "functionName": "add_ip_to_block_list",
                        "id": "21",
                        "selectMore": false,
                        "tab": "apis",
                        "type": "utility",
                        "utilities": {
                            "add_list": {
                                "description": "",
                                "fields": [
                                    {
                                        "choices": "lists",
                                        "description": "",
                                        "label": "list",
                                        "name": "list_name",
                                        "placeholder": "Select a list",
                                        "renderType": "combobox",
                                        "required": true
                                    },
                                    {
                                        "description": "",
                                        "label": "data",
                                        "name": "values",
                                        "placeholder": "Enter data",
                                        "renderType": "datapath",
                                        "required": true
                                    }
                                ],
                                "label": "add to list",
                                "name": "add_list"
                            }
                        },
                        "utilityType": "api",
                        "values": {
                            "add_list": {
                                "list_name": "IP Block List",
                                "values": "search_splunk_for_ips:action_result.data.*.Name"
                            }
                        }
                    },
                    "errors": {},
                    "id": "21",
                    "type": "utility",
                    "x": 440,
                    "y": 1644.5
                },
                "22": {
                    "data": {
                        "advanced": {
                            "customName": "format email",
                            "customNameId": 0,
                            "description": "Include the intelligence context and Splunk results in the email and link to the event in Phantom for the rest of the detail",
                            "join": [],
                            "note": "Include the intelligence context and Splunk results in the email and link to the event in Phantom for the rest of the detail"
                        },
                        "functionId": 6,
                        "functionName": "format_email",
                        "id": "22",
                        "parameters": [
                            "ip_intelligence_1:action_result.parameter.ip",
                            "ip_intelligence_1:action_result.data.*.risk.score",
                            "search_splunk_for_ips:action_result.data.*.Name",
                            "search_splunk_for_domains:action_result",
                            "search_splunk_for_files:action_result.data.*.Name",
                            "search_splunk_for_vulns:action_result.data.*.Name",
                            "container:url",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.other.*.name",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.ip.*.name",
                            "ip_intelligence_1:action_result.data.*.relatedEntities.*.entities.*.entity.name",
                            "ip_intelligence_1:action_result.data.*.intelCard",
                            "ip_intelligence_1:action_result.data.*.location.location.city",
                            "ip_intelligence_1:action_result.data.*.location.location.country",
                            "ip_intelligence_1:action_result.data.*.location.location.continent"
                        ],
                        "template": "The potentially malicious destination IP {0} with a Risk Score of {1} was identified and processed by the Phantom playbook \"recorded_future_threat_hunting_conf\". \n\nThe IP is located in {11}, {12}, {13}\n\nAdditional searches performed against various logs showed that the following linked entities have been found in recent events:\n\nIP addresses: \n{2}\n\ndomain names: \n{3}\n\nfile hashes: \n{4}\n\nvulnerability identifiers: \n{5}\n\nRecorded Future Intelligence has also linked this IP to the following additional Entities:\n{7}\n\nMore details are available in Phantom: {6}\n\nMore details are available in Recorded Future: {10}",
                        "type": "format"
                    },
                    "errors": {},
                    "id": "22",
                    "type": "format",
                    "x": 960,
                    "y": 1360
                },
                "23": {
                    "data": {
                        "advanced": {
                            "customName": "send email if related entities are found",
                            "customNameId": 0,
                            "description": "If any of the Splunk searches had any results, send an email to an analyst",
                            "join": [],
                            "note": "If any of the Splunk searches had any results, send an email to an analyst"
                        },
                        "conditions": [
                            {
                                "comparisons": [
                                    {
                                        "conditionIndex": 0,
                                        "op": ">",
                                        "param": "search_splunk_for_ips:action_result.data.*.RF_Risk_Score",
                                        "value": "64"
                                    },
                                    {
                                        "op": ">",
                                        "param": "search_splunk_for_domains:action_result.data.*.RF_Risk_Score",
                                        "value": "64"
                                    },
                                    {
                                        "op": ">",
                                        "param": "search_splunk_for_files:action_result",
                                        "value": "64"
                                    },
                                    {
                                        "op": ">",
                                        "param": "search_splunk_for_vulns:action_result.data.*.RF_Risk_Score",
                                        "value": "64"
                                    },
                                    {
                                        "op": ">",
                                        "param": "search_splunk_for_urls:action_result.data.*.RF_Risk_Score",
                                        "value": "64"
                                    }
                                ],
                                "conditionIndex": 0,
                                "display": "If",
                                "logic": "or",
                                "type": "if"
                            }
                        ],
                        "functionId": 3,
                        "functionName": "send_email_if_related_entities_are_found",
                        "id": "23",
                        "type": "decision"
                    },
                    "errors": {},
                    "id": "23",
                    "type": "decision",
                    "x": 1040,
                    "y": 1500
                },
                "25": {
                    "data": {
                        "action": "send email",
                        "actionType": "generic",
                        "advanced": {
                            "customName": "send email",
                            "customNameId": 0,
                            "description": "Send the formatted email to a hard-coded recipient",
                            "join": [],
                            "note": "Send the formatted email to a hard-coded recipient"
                        },
                        "connector": "SMTP",
                        "connectorConfigs": [
                            "email"
                        ],
                        "connectorId": "45bb6f37-4478-499b-b4a3-51ecfa62b78c",
                        "connectorVersion": "v1",
                        "functionId": 1,
                        "functionName": "send_email",
                        "id": "25",
                        "parameters": {
                            "body": "format_email:formatted_data",
                            "subject": "Malicous IP with related entities found in Splunk",
                            "to": "placeholder"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "to"
                            },
                            {
                                "data_type": "string",
                                "field": "body"
                            }
                        ],
                        "tab": "byConnector",
                        "type": "action"
                    },
                    "errors": {},
                    "id": "25",
                    "type": "action",
                    "x": 780,
                    "y": 1660
                },
                "26": {
                    "data": {
                        "advanced": {
                            "join": [],
                            "refreshNotableData": true
                        },
                        "functionId": 2,
                        "functionName": "set_severity_add_note_2",
                        "id": "26",
                        "selectMore": false,
                        "tab": "apis",
                        "type": "utility",
                        "utilities": {
                            "add_note": {
                                "description": "",
                                "fields": [
                                    {
                                        "description": "",
                                        "label": "title",
                                        "name": "title",
                                        "placeholder": "Enter a note title",
                                        "renderType": "datapath",
                                        "required": false
                                    },
                                    {
                                        "description": "",
                                        "label": "content",
                                        "name": "content",
                                        "placeholder": "Enter the note content",
                                        "renderType": "datapath",
                                        "required": false
                                    },
                                    {
                                        "choices": [
                                            "markdown",
                                            "html"
                                        ],
                                        "default": "markdown",
                                        "description": "",
                                        "label": "note format",
                                        "name": "note_format",
                                        "placeholder": "Enter the note content",
                                        "renderType": "dropdown",
                                        "required": false
                                    },
                                    {
                                        "hidden": true,
                                        "name": "container",
                                        "required": false
                                    },
                                    {
                                        "default": "general",
                                        "hidden": true,
                                        "name": "note_type",
                                        "required": false
                                    },
                                    {
                                        "hidden": true,
                                        "name": "author",
                                        "required": false
                                    },
                                    {
                                        "hidden": true,
                                        "name": "event_id",
                                        "required": false
                                    },
                                    {
                                        "hidden": true,
                                        "name": "task_id",
                                        "required": false
                                    },
                                    {
                                        "hidden": true,
                                        "name": "trace",
                                        "required": false
                                    }
                                ],
                                "label": "add note",
                                "name": "add_note"
                            },
                            "set_severity": {
                                "description": "",
                                "fields": [
                                    {
                                        "choices": "notableSeverity",
                                        "description": "",
                                        "label": "severity",
                                        "name": "severity",
                                        "placeholder": "Select severity",
                                        "renderType": "dropdown",
                                        "required": true
                                    },
                                    {
                                        "hidden": true,
                                        "name": "container",
                                        "required": false
                                    }
                                ],
                                "label": "set severity",
                                "name": "set_severity",
                                "refreshNotableData": true
                            }
                        },
                        "utilityType": "api",
                        "values": {
                            "add_note": {
                                "_internal": [
                                    "container",
                                    "note_type",
                                    "author",
                                    "event_id",
                                    "task_id",
                                    "trace"
                                ],
                                "content": "format_email:formatted_data",
                                "note_format": "markdown",
                                "note_type": "general",
                                "title": "Recorded Future Intelligence"
                            },
                            "set_severity": {
                                "_internal": [
                                    "container"
                                ],
                                "severity": "high"
                            }
                        }
                    },
                    "errors": {},
                    "id": "26",
                    "type": "utility",
                    "x": 1260,
                    "y": 1660
                },
                "3": {
                    "data": {
                        "advanced": {
                            "description": "Proceed if the risk score is higher than a certain threshold",
                            "join": [],
                            "note": "Proceed if the risk score is higher than a certain threshold"
                        },
                        "conditions": [
                            {
                                "comparisons": [
                                    {
                                        "conditionIndex": 0,
                                        "op": ">=",
                                        "param": "ip_intelligence_1:action_result.data.*.risk.score",
                                        "value": "90"
                                    }
                                ],
                                "conditionIndex": 0,
                                "display": "If",
                                "logic": "and",
                                "type": "if"
                            }
                        ],
                        "functionId": 1,
                        "functionName": "decision_1",
                        "id": "3",
                        "type": "decision"
                    },
                    "errors": {},
                    "id": "3",
                    "type": "decision",
                    "x": 1140,
                    "y": 580
                },
                "4": {
                    "data": {
                        "advanced": {
                            "customName": "format linked ip lookup",
                            "customNameId": 0,
                            "description": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model",
                            "join": [],
                            "note": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model"
                        },
                        "functionId": 1,
                        "functionName": "format_linked_ip_lookup",
                        "id": "4",
                        "parameters": [
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.ip.*.name",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.ip.*.score"
                        ],
                        "template": "| eval Name=\"{0}\" | makemv Name delim=\", \" | mvexpand Name | appendcols [| makeresults | eval RF_Risk_Score=\"{1}\" | makemv RF_Risk_Score delim=\", \" | mvexpand RF_Risk_Score ] | outputlookup huntip.csv",
                        "type": "format"
                    },
                    "errors": {},
                    "id": "4",
                    "type": "format",
                    "x": 440,
                    "y": 760
                },
                "5": {
                    "data": {
                        "advanced": {
                            "customName": "format linked domain lookup",
                            "customNameId": 0,
                            "description": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model",
                            "join": [],
                            "note": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model"
                        },
                        "functionId": 2,
                        "functionName": "format_linked_domain_lookup",
                        "id": "5",
                        "parameters": [
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.domain.*.name",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.domain.*.score"
                        ],
                        "template": "| eval Name=\"{0}\" | makemv Name delim=\", \" | mvexpand Name | appendcols [| makeresults | eval RF_Risk_Score=\"{1}\" | makemv RF_Risk_Score delim=\", \" | mvexpand RF_Risk_Score ] | outputlookup huntdomain.csv",
                        "type": "format"
                    },
                    "errors": {},
                    "id": "5",
                    "type": "format",
                    "x": 740,
                    "y": 780
                },
                "6": {
                    "data": {
                        "advanced": {
                            "customName": "format linked files lookup",
                            "customNameId": 0,
                            "description": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model",
                            "join": [],
                            "note": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model"
                        },
                        "functionId": 3,
                        "functionName": "format_linked_files_lookup",
                        "id": "6",
                        "parameters": [
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.file.*.name",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.file.*.score"
                        ],
                        "template": "| eval Name=\"{0}\" | makemv Name delim=\", \" | mvexpand Name | appendcols [| makeresults | eval RF_Risk_Score=\"{1}\" | makemv RF_Risk_Score delim=\", \" | mvexpand RF_Risk_Score ] | outputlookup huntfile.csv",
                        "type": "format"
                    },
                    "errors": {},
                    "id": "6",
                    "type": "format",
                    "x": 1060,
                    "y": 860
                },
                "7": {
                    "data": {
                        "advanced": {
                            "customName": "format linked vuln lookup",
                            "customNameId": 0,
                            "description": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model",
                            "join": [],
                            "note": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model"
                        },
                        "functionId": 4,
                        "functionName": "format_linked_vuln_lookup",
                        "id": "7",
                        "parameters": [
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.vulnerability.*.name",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.vulnerability.*.score"
                        ],
                        "template": "| eval Name=\"{0}\" | makemv Name delim=\", \" | mvexpand Name | appendcols [| makeresults | eval RF_Risk_Score=\"{1}\" | makemv RF_Risk_Score delim=\", \" | mvexpand RF_Risk_Score ] | outputlookup huntvuln.csv",
                        "type": "format"
                    },
                    "errors": {},
                    "id": "7",
                    "type": "format",
                    "x": 1380,
                    "y": 780
                },
                "8": {
                    "data": {
                        "advanced": {
                            "customName": "format linked url lookup",
                            "customNameId": 0,
                            "description": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model",
                            "join": [],
                            "note": "Build a Splunk query to turn a list of linked entities from Recorded Future into a lookup table that can be used for threat hunting across any sourcetype or data model"
                        },
                        "functionId": 5,
                        "functionName": "format_linked_url_lookup",
                        "id": "8",
                        "parameters": [
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.url.*.name",
                            "ip_intelligence_1:action_result.data.*.recordedfutureLinks.entities.url.*.score"
                        ],
                        "template": "| eval Name=\"{0}\" | makemv Name delim=\", \" | mvexpand Name | appendcols [| makeresults | eval RF_Risk_Score=\"{1}\" | makemv RF_Risk_Score delim=\", \" | mvexpand RF_Risk_Score ] | outputlookup hunturl.csv",
                        "type": "format"
                    },
                    "errors": {},
                    "id": "8",
                    "type": "format",
                    "x": 1680,
                    "y": 760
                },
                "9": {
                    "data": {
                        "action": "run query",
                        "actionType": "investigate",
                        "advanced": {
                            "customName": "build ip lookup",
                            "customNameId": 0,
                            "description": "Run the Splunk query that creates the lookup file",
                            "join": [],
                            "note": "Run the Splunk query that creates the lookup file"
                        },
                        "connector": "Splunk",
                        "connectorConfigs": [
                            "splunk"
                        ],
                        "connectorId": "91883aa8-9c81-470b-97a1-5d8f7995f560",
                        "connectorVersion": "v1",
                        "functionId": 1,
                        "functionName": "build_ip_lookup",
                        "id": "9",
                        "parameters": {
                            "command": "| makeresults",
                            "query": "format_linked_ip_lookup:formatted_data"
                        },
                        "requiredParameters": [
                            {
                                "data_type": "string",
                                "field": "query"
                            },
                            {
                                "data_type": "string",
                                "default": "search",
                                "field": "command"
                            }
                        ],
                        "type": "action"
                    },
                    "errors": {},
                    "id": "9",
                    "type": "action",
                    "x": 440,
                    "y": 980
                }
            },
            "notes": "This playbook uses the following Apps:\n - Recorded Future (ip intelligence) [asset name = recordedfuture] - gather threat information and linked entities associated with an IP address\n - Splunk (run query) [asset name = splunkes_hunt] - build lookup files and query events\n - SMTP (send email) [asset name = smtp] - send an email\n\nDeployment Notes:\n - This playbook should be spawned manually or through high fidelity correlation searches\n - The initial indicator used is an IP address, but this could be adapted to other types of indicators\n - The email sender and recipient address are hard-coded and must be changed\n - The \"admin\" user should be replaced in the prompt to refer to a user or role that should be involved\n - The Splunk searches that create lookups can probably be reused, but the \"search splunk for x\" searches will probably need to be adapted or replaced to fit available data models or data sources in the target environment\n - Adding an IP to a block list allows firewalls such as Palo Alto Networks NGFW to query the Phantom REST API and use the list as an external block list"
        },
        "input_spec": null,
        "output_spec": null,
        "playbook_type": "automation",
        "python_version": "3",
        "schema": "5.0.8",
        "version": "5.3.4.95226"
    },
    "create_time": "2022-10-24T18:06:10.346594+00:00",
    "draft_mode": false,
    "labels": [
        "*"
    ],
    "tags": []
}